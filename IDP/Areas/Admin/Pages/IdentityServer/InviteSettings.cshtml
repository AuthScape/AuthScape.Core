@page
@model IDP.Areas.Admin.Pages.IdentityServer.InviteSettingsModel
@{
    ViewData["Title"] = "Invite Settings";
    Layout = "_AdminLayout";
}

<div class="invite-settings-container">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Invite Settings</h1>
            <p class="page-subtitle">Configure invitation policies and per-company overrides</p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fa fa-check-circle me-2"></i>@Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fa fa-exclamation-circle me-2"></i>@Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Global Settings Section -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-icon">
                <i class="fa fa-globe"></i>
            </div>
            <div>
                <h2 class="section-title">Global Settings</h2>
                <p class="section-subtitle">Default settings applied to all companies unless overridden</p>
            </div>
        </div>

        <form method="post" asp-page-handler="UpdateGlobal" class="settings-form">
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Enable Invite to Company</div>
                        <div class="setting-description">Allow users to invite others to their company</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enableInviteToCompany" id="globalEnableInviteToCompany"
                               @(Model.GlobalSettings.EnableInviteToCompany ? "checked" : "") value="true">
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Enable Invite to Location</div>
                        <div class="setting-description">Allow users to invite others to a specific location</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enableInviteToLocation" id="globalEnableInviteToLocation"
                               @(Model.GlobalSettings.EnableInviteToLocation ? "checked" : "") value="true">
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Allow Setting Permissions</div>
                        <div class="setting-description">Allow inviters to assign permissions to new users</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="allowSettingPermissions" id="globalAllowSettingPermissions"
                               @(Model.GlobalSettings.AllowSettingPermissions ? "checked" : "") value="true">
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Allow Setting Roles</div>
                        <div class="setting-description">Allow inviters to assign roles to new users</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="allowSettingRoles" id="globalAllowSettingRoles"
                               @(Model.GlobalSettings.AllowSettingRoles ? "checked" : "") value="true">
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Enforce Same Permissions</div>
                        <div class="setting-description">Inviters can only assign permissions they have</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enforceSamePermissions" id="globalEnforceSamePermissions"
                               @(Model.GlobalSettings.EnforceSamePermissions ? "checked" : "") value="true">
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Enforce Same Role</div>
                        <div class="setting-description">Inviters can only assign roles they have</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enforceSameRole" id="globalEnforceSameRole"
                               @(Model.GlobalSettings.EnforceSameRole ? "checked" : "") value="true">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-save me-2"></i>Save Global Settings
                </button>
            </div>
        </form>
    </div>

    <!-- Company Overrides Section -->
    <div class="settings-section">
        <div class="section-header">
            <div class="section-icon section-icon-company">
                <i class="fa fa-building"></i>
            </div>
            <div>
                <h2 class="section-title">Company Overrides</h2>
                <p class="section-subtitle">Custom settings for specific companies</p>
            </div>
            <button type="button" class="btn-add" onclick="showCreateOverrideModal()">
                <i class="fa fa-plus"></i> Add Override
            </button>
        </div>

        <div class="overrides-table-container">
            <table class="overrides-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th class="text-center">Invite to Company</th>
                        <th class="text-center">Invite to Location</th>
                        <th class="text-center">Set Permissions</th>
                        <th class="text-center">Set Roles</th>
                        <th class="text-center">Enforce Permissions</th>
                        <th class="text-center">Enforce Roles</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.CompanyOverrides.Count == 0)
                    {
                        <tr>
                            <td colspan="8" class="text-center empty-state">
                                <div class="empty-icon">
                                    <i class="fa fa-building"></i>
                                </div>
                                <div class="empty-title">No company overrides</div>
                                <div class="empty-subtitle">All companies use global settings. Add an override for custom configuration.</div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var override_ in Model.CompanyOverrides)
                        {
                            <tr class="override-row">
                                <td>
                                    <div class="company-name">
                                        <i class="fa fa-building company-icon"></i>
                                        <span>@override_.CompanyName</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <i class="fa @(override_.EnableInviteToCompany ? "fa-check-circle text-success" : "fa-times-circle text-danger")"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fa @(override_.EnableInviteToLocation ? "fa-check-circle text-success" : "fa-times-circle text-danger")"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fa @(override_.AllowSettingPermissions ? "fa-check-circle text-success" : "fa-times-circle text-danger")"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fa @(override_.AllowSettingRoles ? "fa-check-circle text-success" : "fa-times-circle text-danger")"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fa @(override_.EnforceSamePermissions ? "fa-check-circle text-success" : "fa-times-circle text-danger")"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fa @(override_.EnforceSameRole ? "fa-check-circle text-success" : "fa-times-circle text-danger")"></i>
                                </td>
                                <td class="text-end">
                                    <div class="action-buttons">
                                        <button type="button" class="btn-action btn-action-edit"
                                                onclick="showEditOverrideModal(@override_.CompanyId, '@override_.CompanyName', @override_.EnableInviteToCompany.ToString().ToLower(), @override_.EnableInviteToLocation.ToString().ToLower(), @override_.AllowSettingPermissions.ToString().ToLower(), @override_.AllowSettingRoles.ToString().ToLower(), @override_.EnforceSamePermissions.ToString().ToLower(), @override_.EnforceSameRole.ToString().ToLower())"
                                                title="Edit">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn-action btn-action-delete"
                                                onclick="showDeleteOverrideModal(@override_.CompanyId, '@override_.CompanyName')"
                                                title="Delete">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Override Modal -->
<div class="modal fade" id="createOverrideModal" tabindex="-1" aria-labelledby="createOverrideModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateOverride">
                <div class="modal-header">
                    <h5 class="modal-title" id="createOverrideModalLabel">
                        <i class="fa fa-plus-circle me-2"></i>Create Company Override
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label for="createCompanyId" class="form-label">Company</label>
                        <select class="form-select" id="createCompanyId" name="companyId" required>
                            <option value="">Select a company...</option>
                            @foreach (var company in Model.Companies)
                            {
                                <option value="@company.Id">@company.Title</option>
                            }
                        </select>
                    </div>

                    <div class="settings-grid modal-settings">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enable Invite to Company</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enableInviteToCompany" id="createEnableInviteToCompany" checked value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enable Invite to Location</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enableInviteToLocation" id="createEnableInviteToLocation" checked value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Allow Setting Permissions</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="allowSettingPermissions" id="createAllowSettingPermissions" checked value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Allow Setting Roles</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="allowSettingRoles" id="createAllowSettingRoles" checked value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enforce Same Permissions</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enforceSamePermissions" id="createEnforceSamePermissions" value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enforce Same Role</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enforceSameRole" id="createEnforceSameRole" value="true">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save me-2"></i>Create Override
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Override Modal -->
<div class="modal fade" id="editOverrideModal" tabindex="-1" aria-labelledby="editOverrideModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="UpdateOverride">
                <input type="hidden" id="editCompanyId" name="companyId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="editOverrideModalLabel">
                        <i class="fa fa-edit me-2"></i>Edit Override: <span id="editCompanyName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="settings-grid modal-settings">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enable Invite to Company</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enableInviteToCompany" id="editEnableInviteToCompany" value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enable Invite to Location</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enableInviteToLocation" id="editEnableInviteToLocation" value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Allow Setting Permissions</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="allowSettingPermissions" id="editAllowSettingPermissions" value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Allow Setting Roles</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="allowSettingRoles" id="editAllowSettingRoles" value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enforce Same Permissions</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enforceSamePermissions" id="editEnforceSamePermissions" value="true">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Enforce Same Role</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enforceSameRole" id="editEnforceSameRole" value="true">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Override Modal -->
<div class="modal fade" id="deleteOverrideModal" tabindex="-1" aria-labelledby="deleteOverrideModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="DeleteOverride">
                <input type="hidden" id="deleteCompanyId" name="companyId" />
                <div class="modal-header border-0">
                    <h5 class="modal-title text-danger" id="deleteOverrideModalLabel">
                        <i class="fa fa-exclamation-triangle me-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Are you sure you want to delete the override for <strong id="deleteCompanyName"></strong>?</p>
                    <p class="text-muted small mb-0 mt-2">This company will use global settings instead.</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fa fa-trash me-2"></i>Delete Override
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showCreateOverrideModal() {
            var modal = new bootstrap.Modal(document.getElementById('createOverrideModal'));
            modal.show();
        }

        function showEditOverrideModal(companyId, companyName, enableInviteToCompany, enableInviteToLocation, allowSettingPermissions, allowSettingRoles, enforceSamePermissions, enforceSameRole) {
            document.getElementById('editCompanyId').value = companyId;
            document.getElementById('editCompanyName').textContent = companyName;
            document.getElementById('editEnableInviteToCompany').checked = enableInviteToCompany;
            document.getElementById('editEnableInviteToLocation').checked = enableInviteToLocation;
            document.getElementById('editAllowSettingPermissions').checked = allowSettingPermissions;
            document.getElementById('editAllowSettingRoles').checked = allowSettingRoles;
            document.getElementById('editEnforceSamePermissions').checked = enforceSamePermissions;
            document.getElementById('editEnforceSameRole').checked = enforceSameRole;
            var modal = new bootstrap.Modal(document.getElementById('editOverrideModal'));
            modal.show();
        }

        function showDeleteOverrideModal(companyId, companyName) {
            document.getElementById('deleteCompanyId').value = companyId;
            document.getElementById('deleteCompanyName').textContent = companyName;
            var modal = new bootstrap.Modal(document.getElementById('deleteOverrideModal'));
            modal.show();
        }
    </script>
}

@section Styles {
    <style>
        .invite-settings-container {
            max-width: 1400px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .page-subtitle {
            color: var(--gray-600);
            margin: 0.5rem 0 0;
            font-size: 0.95rem;
        }

        .settings-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .section-icon-company {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));
            color: #3b82f6;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .section-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin: 0.25rem 0 0;
        }

        .btn-add {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            margin-left: auto;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
        }

        .modal-settings {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
            transition: background 0.2s;
        }

        .setting-item:hover {
            background: var(--gray-100);
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 0.95rem;
        }

        .setting-description {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .form-check-input {
            width: 3rem;
            height: 1.5rem;
            cursor: pointer;
        }

        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .form-actions {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        .overrides-table-container {
            overflow-x: auto;
        }

        .overrides-table {
            width: 100%;
            border-collapse: collapse;
        }

        .overrides-table thead {
            background: var(--gray-50);
        }

        .overrides-table th {
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
        }

        .overrides-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .override-row:hover {
            background: var(--gray-50);
        }

        .override-row:last-child td {
            border-bottom: none;
        }

        .company-name {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .company-icon {
            color: #3b82f6;
            font-size: 1rem;
        }

        .text-success {
            color: #22c55e !important;
        }

        .text-danger {
            color: #ef4444 !important;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-action {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .btn-action-edit {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .btn-action-edit:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .btn-action-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-action-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
        }

        .empty-state {
            padding: 3rem 2rem !important;
        }

        .empty-icon {
            font-size: 3rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .empty-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .section-header {
                flex-wrap: wrap;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .btn-add {
                margin-left: 0;
                margin-top: 1rem;
            }
        }
    </style>
}
