@page
@using Microsoft.AspNetCore.Http.Features
@model TwoFactorAuthenticationModel
@{
    ViewData["Title"] = "PassKey";
    ViewData["ActivePage"] = ManageNavPages.PassKey;
}

@* <partial name="_StatusMessage" for="StatusMessage" /> *@
<h3>@ViewData["Title"]</h3>
@{
    // var consentFeature = HttpContext.Features.Get<ITrackingConsentFeature>();
    // @if (consentFeature?.CanTrack ?? true)
    // {
    //     @if (Model.Is2faEnabled)
    //     {
    //         if (Model.RecoveryCodesLeft == 0)
    //         {
    //             <div class="alert alert-danger">
    //                 <strong>You have no recovery codes left.</strong>
    //                 <p>You must <a asp-page="./GenerateRecoveryCodes">generate a new set of recovery codes</a> before you can log in with a recovery code.</p>
    //             </div>
    //         }
    //         else if (Model.RecoveryCodesLeft == 1)
    //         {
    //             <div class="alert alert-danger">
    //                 <strong>You have 1 recovery code left.</strong>
    //                 <p>You can <a asp-page="./GenerateRecoveryCodes">generate a new set of recovery codes</a>.</p>
    //             </div>
    //         }
    //         else if (Model.RecoveryCodesLeft <= 3)
    //         {
    //             <div class="alert alert-warning">
    //                 <strong>You have @Model.RecoveryCodesLeft recovery codes left.</strong>
    //                 <p>You should <a asp-page="./GenerateRecoveryCodes">generate a new set of recovery codes</a>.</p>
    //             </div>
    //         }

    //         if (Model.IsMachineRemembered)
    //         {
    //             <form method="post" style="display: inline-block">
    //                 <button type="submit" class="btn btn-primary">Forget this browser</button>
    //             </form>
    //         }
    //         <a asp-page="./Disable2fa" class="btn btn-primary">Disable 2FA</a>
    //         <a asp-page="./GenerateRecoveryCodes" class="btn btn-primary">Reset recovery codes</a>
    //     }

    //     <h4>Authenticator app</h4>
    //     @if (!Model.HasAuthenticator)
    //     {
    //         <a id="enable-authenticator" asp-page="./EnableAuthenticator" class="btn btn-primary">Add authenticator app</a>
    //     }
    //     else
    //     {
    //         <a id="enable-authenticator" asp-page="./EnableAuthenticator" class="btn btn-primary">Set up authenticator app</a>
    //         <a id="reset-authenticator" asp-page="./ResetAuthenticator" class="btn btn-primary">Reset authenticator app</a>
    //     }
    // }
    // else
    // {
    //     <div class="alert alert-danger">
    //         <strong>Privacy and cookie policy have not been accepted.</strong>
    //         <p>You must accept the policy before you can enable two factor authentication.</p>
    //     </div>
    // }

    <div>
        <button onclick="register()">Register Device</button>
    </div>

}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script type="text/javascript">

        // Helper functions for encoding/decoding
        function base64urlToArrayBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const binary = atob(base64);
            const buffer = new ArrayBuffer(binary.length);
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return buffer;
        }

        function arrayBufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            const binary = String.fromCharCode(...bytes);
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // Registration Flow
        async function register() {
            const username = "@(Model.User.Identity.Name)";

            // Step 1: Get registration options from server
            const optionsResponse = await fetch(`/Home/GetRegistrationOptions?username=${encodeURIComponent(username)}`);
            const options = await optionsResponse.json();

                    // In your register() function
            const publicKey = {
                ...options,
                rpId: "localhost", // Must match ServerDomain
                challenge: base64urlToArrayBuffer(options.challenge),
                user: {
                    ...options.user,
                    id: base64urlToArrayBuffer(options.user.id)
                }
            };

            // Step 3: Create credential using browser API
            const credential = await navigator.credentials.create({ publicKey });

            // Step 4: Format response for server
            const response = {
                id: credential.id,
                rawId: arrayBufferToBase64url(credential.rawId),
                type: credential.type,
                response: {
                    attestationObject: arrayBufferToBase64url(credential.response.attestationObject),
                    clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON)
                }
            };

            // Step 5: Send registration to server
            const registrationResponse = await fetch('/Home/RegisterCredential', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json' // 👈 Ensure you accept JSON responses
                },
                body: JSON.stringify(response)
            });

            if (registrationResponse.ok) {
                alert('Registration successful!');
            } else {
                alert('Registration failed: ' + await registrationResponse.text());
            }
        }

        // Login Flow
        async function login() {
            const username = document.getElementById('username').value;

            // Step 1: Get assertion options from server
            const optionsResponse = await fetch(`/Home/GetAssertionOptions?username=${encodeURIComponent(username)}`);
            const options = await optionsResponse.json();

            // Step 2: Convert options for WebAuthn API
            const publicKey = {
                ...options,
                challenge: base64urlToArrayBuffer(options.challenge),
                allowCredentials: options.allowCredentials?.map(cred => ({
                    ...cred,
                    id: base64urlToArrayBuffer(cred.id)
                }))
            };

            // Step 3: Get assertion using browser API
            const assertion = await navigator.credentials.get({ publicKey });

            // Step 4: Format response for server
            const response = {
                id: assertion.id,
                rawId: arrayBufferToBase64url(assertion.rawId),
                type: assertion.type,
                response: {
                    authenticatorData: arrayBufferToBase64url(assertion.response.authenticatorData),
                    clientDataJSON: arrayBufferToBase64url(assertion.response.clientDataJSON),
                    signature: arrayBufferToBase64url(assertion.response.signature),
                    userHandle: assertion.response.userHandle ?
                        arrayBufferToBase64url(assertion.response.userHandle) : null
                }
            };

            // Step 5: Verify assertion with server
            const verificationResponse = await fetch('/Home/VerifyAssertion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(response)
            });

            if (verificationResponse.ok) {
                // alert('Login successful!');
                // Redirect or update UI here

                const data = await verificationResponse.text();
                // const jsonData = await verificationResponse.json();

                window.location.href = data;


            } else {
                alert('Login failed: ' + await verificationResponse.text());
            }
        }

    </script>
}
