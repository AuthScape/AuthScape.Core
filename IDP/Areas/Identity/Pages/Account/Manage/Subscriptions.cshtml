@page "/Subscriptions"
@model IDP.Areas.Identity.Pages.Account.Manage.SubscriptionsModel

@{
    ViewData["Title"] = "Subscriptions";
    ViewData["ActivePage"] = "Subscriptions";
}

@Html.AntiForgeryToken()

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/css/manage-pages.css" rel="stylesheet" />

<style>
    .subscription-item {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius-lg);
        padding: 1.75rem;
        margin-bottom: 1rem;
        transition: all var(--transition-base);
    }

    .subscription-item:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .subscription-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 1.25rem;
    }

    .subscription-info {
        flex: 1;
    }

    .subscription-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .subscription-price {
        font-size: 2rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: inline-block;
    }

    .subscription-interval {
        color: var(--gray-500);
        font-size: 1rem;
        font-weight: 500;
    }

    .subscription-meta {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }

    .subscription-meta-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .subscription-meta-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-500);
        font-weight: 600;
    }

    .subscription-meta-value {
        font-size: 0.95rem;
        color: var(--gray-900);
        font-weight: 500;
    }

    .subscription-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .plan-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .plan-option {
        position: relative;
        border: 3px solid var(--gray-200);
        border-radius: var(--border-radius-lg);
        padding: 1.75rem;
        cursor: pointer;
        transition: all var(--transition-base);
        background: white;
    }

    .plan-option:hover {
        border-color: var(--primary-color);
        transform: scale(1.02);
        box-shadow: var(--shadow-lg);
    }

    .plan-option.selected {
        border-color: var(--primary-color);
        background: linear-gradient(to bottom, rgba(102, 126, 234, 0.03), white);
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .plan-option.selected::before {
        content: 'âœ“';
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 28px;
        height: 28px;
        background: var(--primary-gradient);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
    }

    .plan-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 1rem;
    }

    .plan-price {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .plan-interval {
        color: var(--gray-500);
        font-size: 0.95rem;
        margin-bottom: 1.25rem;
    }

    .plan-description {
        color: var(--gray-600);
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .subscription-details-form {
        background: var(--gray-50);
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        border: 2px solid var(--gray-200);
    }

    .selected-plan-summary {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius-md);
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-color);
    }

    .trial-info {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        padding: 1rem 1.25rem;
        border-radius: var(--border-radius-md);
        margin-top: 1rem;
        border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .trial-checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        font-weight: 500;
    }
</style>

<div class="manage-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-actions">
            <div>
                <h1>Subscriptions</h1>
                <p>Manage your subscription plans and billing preferences</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSubscriptionModal">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                New Subscription
            </button>
        </div>
    </div>

    <!-- Active Subscriptions Section -->
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Active Subscriptions</h2>
                <p class="card-subtitle">Your currently active subscription plans</p>
            </div>
        </div>
        <div class="card-body">
            <div id="subscriptions-container">
                <div class="text-center py-5">
                    <div class="spinner spinner-primary" style="width: 40px; height: 40px; border-width: 4px;"></div>
                    <p class="text-muted mt-3">Loading subscriptions...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Past Subscriptions Section -->
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Past Subscriptions</h2>
                <p class="card-subtitle">Previously canceled or expired subscriptions</p>
            </div>
        </div>
        <div class="card-body">
            <div id="past-subscriptions-container">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“‹</div>
                    <h3 class="empty-state-title">No past subscriptions</h3>
                    <p class="empty-state-description">Your canceled subscriptions will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Subscription Modal -->
<div class="modal fade" id="newSubscriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Choose a Plan</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Plan Selection -->
                <div id="plans-container" class="plan-selector">
                    <div class="text-center py-5" style="grid-column: 1/-1;">
                        <div class="spinner spinner-primary" style="width: 40px; height: 40px; border-width: 4px;"></div>
                        <p class="text-muted mt-3">Loading available plans...</p>
                    </div>
                </div>

                <!-- Subscription Details Form -->
                <div id="subscription-details" style="display: none;">
                    <div class="subscription-details-form">
                        <h3 class="mb-3" style="font-size: 1.25rem; font-weight: 600;">Subscription Details</h3>

                        <!-- Selected Plan Summary -->
                        <div class="selected-plan-summary">
                            <div class="form-label mb-2">Selected Plan</div>
                            <div id="selected-plan-display" style="font-size: 1.125rem; font-weight: 600; color: var(--gray-900);"></div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select id="payment-method-select" class="form-control form-select">
                                <option value="">Loading payment methods...</option>
                            </select>
                            <span class="form-help">Select a payment method for this subscription</span>
                        </div>

                        <!-- Promo Code -->
                        <div class="form-group">
                            <label class="form-label">Promo Code (Optional)</label>
                            <input type="text" id="promo-code-input" class="form-control" placeholder="Enter promo code">
                            <span class="form-help">Have a discount code? Enter it here</span>
                        </div>

                        <!-- Trial Period -->
                        <div class="trial-info">
                            <label class="trial-checkbox-label">
                                <input class="form-check-input" type="checkbox" id="trial-checkbox" style="width: 20px; height: 20px;">
                                <span>
                                    Start with <strong id="trial-days">14</strong>-day free trial
                                </span>
                            </label>
                            <p class="mb-0 mt-2" style="font-size: 0.875rem; color: var(--gray-600); margin-left: 2rem;">
                                You won't be charged until the trial period ends. Cancel anytime.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="create-subscription-btn" style="display: none;">
                    <span>Subscribe Now</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentWalletId = '@Model.ActiveWalletId';
    let selectedPlanId = null;
    let currentSubscriptionId = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadSubscriptions();
        loadPlans();
        loadPaymentMethods();

        document.getElementById('create-subscription-btn').addEventListener('click', createSubscription);
    });

    async function loadSubscriptions() {
        try {
            const response = await fetch('/api/Subscription/GetMySubscriptions?includeInactive=false', {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                renderSubscriptions(data.subscriptions, 'subscriptions-container');

                // Load past subscriptions
                const pastResponse = await fetch('/api/Subscription/GetMySubscriptions?includeInactive=true', {
                    credentials: 'include'
                });
                const pastData = await pastResponse.json();
                if (pastData.success) {
                    const pastSubs = pastData.subscriptions.filter(s => s.status === 'Canceled');
                    renderSubscriptions(pastSubs, 'past-subscriptions-container', true);
                }
            }
        } catch (error) {
            console.error('Error loading subscriptions:', error);
            document.getElementById('subscriptions-container').innerHTML = '<div class="alert alert-danger">Failed to load subscriptions</div>';
        }
    }

    function renderSubscriptions(subscriptions, containerId, isPast = false) {
        const container = document.getElementById(containerId);

        if (!subscriptions || subscriptions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">${isPast ? 'ðŸ“‹' : 'ðŸŽ¯'}</div>
                    <h3 class="empty-state-title">${isPast ? 'No past subscriptions' : 'No active subscriptions'}</h3>
                    <p class="empty-state-description">${isPast ? 'Your canceled subscriptions will appear here' : 'Get started by subscribing to a plan'}</p>
                    ${!isPast ? '<button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#newSubscriptionModal">Subscribe Now</button>' : ''}
                </div>
            `;
            return;
        }

        container.innerHTML = subscriptions.map(sub => {
            const statusClass = sub.status.toLowerCase();
            const statusColors = {
                active: 'success',
                trialing: 'info',
                'past-due': 'warning',
                canceled: 'danger',
                paused: 'gray'
            };
            const badgeClass = statusColors[statusClass] || 'gray';

            return `
                <div class="subscription-item">
                    <div class="subscription-header">
                        <div class="subscription-info">
                            <div class="subscription-title">
                                ${sub.productName || 'Subscription'}
                                <span class="badge badge-${badgeClass}">${sub.status}</span>
                                ${sub.status === 'Trialing' ? '<span class="badge" style="background: var(--primary-gradient); color: white;">Free Trial</span>' : ''}
                            </div>
                            <div>
                                <span class="subscription-price">$${(sub.amount || 0).toFixed(2)}</span>
                                <span class="subscription-interval">/ ${sub.intervalCount > 1 ? sub.intervalCount + ' ' : ''}${sub.interval}${sub.intervalCount > 1 ? 's' : ''}</span>
                            </div>
                            <div class="subscription-meta">
                                <div class="subscription-meta-item">
                                    <span class="subscription-meta-label">${sub.status === 'Trialing' ? 'Trial Ends' : 'Next Billing'}</span>
                                    <span class="subscription-meta-value">${new Date(sub.status === 'Trialing' ? sub.trialEnd : sub.currentPeriodEnd).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                                ${sub.cancelAtPeriodEnd ? `
                                <div class="subscription-meta-item">
                                    <span class="subscription-meta-label">Status</span>
                                    <span class="subscription-meta-value" style="color: var(--danger-color);">Cancels at period end</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ${!isPast ? `
                        <div class="subscription-actions">
                            <button class="btn btn-sm btn-outline" onclick="manageSubscription('${sub.id}')">Manage</button>
                            ${!sub.cancelAtPeriodEnd ?
                                `<button class="btn btn-sm btn-danger" onclick="cancelSubscription('${sub.id}')">Cancel</button>` :
                                `<button class="btn btn-sm btn-success" onclick="resumeSubscription('${sub.id}')">Resume</button>`
                            }
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadPlans() {
        try {
            const response = await fetch('/api/Subscription/GetAvailablePlans', {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.plans) {
                renderPlans(data.plans);
            }
        } catch (error) {
            console.error('Error loading plans:', error);
        }
    }

    function renderPlans(plans) {
        const container = document.getElementById('plans-container');

        container.innerHTML = plans.map(plan => `
            <div class="plan-option" onclick="selectPlan('${plan.priceId}', '${plan.productName}', ${plan.amount}, '${plan.interval}', ${plan.trialPeriodDays || 0})">
                <div class="plan-name">${plan.productName}</div>
                <div class="plan-price">$${plan.amount.toFixed(2)}</div>
                <div class="plan-interval">per ${plan.interval}</div>
                ${plan.description ? `<p class="plan-description">${plan.description}</p>` : ''}
                ${plan.trialPeriodDays ? `
                    <div class="mt-3">
                        <span class="badge" style="background: var(--primary-gradient); color: white;">
                            ${plan.trialPeriodDays} days free trial
                        </span>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    function selectPlan(priceId, planName, amount, interval, trialDays) {
        selectedPlanId = priceId;

        // Update UI
        document.querySelectorAll('.plan-option').forEach(card => card.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        document.getElementById('selected-plan-display').textContent = `${planName} - $${amount.toFixed(2)}/${interval}`;
        document.getElementById('trial-days').textContent = trialDays || 14;
        document.getElementById('subscription-details').style.display = 'block';
        document.getElementById('create-subscription-btn').style.display = 'inline-flex';
    }

    async function loadPaymentMethods() {
        try {
            const response = await fetch('/api/Payment/GetPaymentMethods?paymentMethodType=User', {
                credentials: 'include'
            });

            const methods = await response.json();
            const select = document.getElementById('payment-method-select');

            if (methods && methods.length > 0) {
                select.innerHTML = methods.map(pm =>
                    `<option value="${pm.paymentMethodId}">${pm.brand || pm.bankName} â€¢â€¢â€¢â€¢ ${pm.last4}</option>`
                ).join('');
            } else {
                select.innerHTML = '<option value="">No payment methods - add one first</option>';
            }
        } catch (error) {
            console.error('Error loading payment methods:', error);
        }
    }

    async function createSubscription() {
        const paymentMethodId = document.getElementById('payment-method-select').value;
        const promoCode = document.getElementById('promo-code-input').value;
        const useTrial = document.getElementById('trial-checkbox').checked;

        if (!selectedPlanId || !paymentMethodId) {
            alert('Please select a plan and payment method');
            return;
        }

        const btn = document.getElementById('create-subscription-btn');
        const btnText = btn.querySelector('span');
        btn.disabled = true;
        btnText.textContent = 'Creating...';

        try {
            const requestBody = {
                priceId: selectedPlanId,
                paymentMethodId: paymentMethodId
            };

            // Only add optional fields if they have values
            if (promoCode) {
                requestBody.promoCode = promoCode;
            }

            if (useTrial) {
                requestBody.trialPeriodDays = parseInt(document.getElementById('trial-days').textContent);
            }

            const response = await fetch('/api/Subscription/CreateSubscription', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(requestBody)
            });

            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('newSubscriptionModal')).hide();
                alert('Subscription created successfully!');
                loadSubscriptions();
            } else {
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
        } catch (error) {
            console.error('Error creating subscription:', error);
            alert('Failed to create subscription: ' + error.message);
        } finally {
            btn.disabled = false;
            btnText.textContent = 'Subscribe Now';
        }
    }

    async function cancelSubscription(subscriptionId) {
        if (!confirm('Are you sure you want to cancel this subscription? It will remain active until the end of the current billing period.')) {
            return;
        }

        try {
            const response = await fetch('/api/Subscription/CancelSubscription', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    subscriptionId: subscriptionId,
                    cancelImmediately: false
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Subscription canceled. It will remain active until the end of your billing period.');
                loadSubscriptions();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error canceling subscription:', error);
            alert('Failed to cancel subscription');
        }
    }

    async function resumeSubscription(subscriptionId) {
        try {
            const response = await fetch('/api/Subscription/ResumeSubscription', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    subscriptionId: subscriptionId
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Subscription resumed successfully!');
                loadSubscriptions();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error resuming subscription:', error);
            alert('Failed to resume subscription');
        }
    }

    function manageSubscription(subscriptionId) {
        // TODO: Implement subscription management modal
        alert('Subscription management coming soon!');
    }

</script>
