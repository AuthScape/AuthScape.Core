@page "/Wallets"
@model IDP.Areas.Identity.Pages.Account.Manage.WalletModel

@{
    ViewData["Title"] = "Payment Methods";
    ViewData["ActivePage"] = ManageNavPages.PaymentMethods;
    var pk = Model.StripePublicKey;
    var walletBalance = Model.Balance;
    var activeWalletId = Model.ActiveWalletId;

    // Set from backend if redirect returned requires_action → verify_with_microdeposits
    var achVerifyPending = (bool?)ViewData["AchVerifyPending"] == true;
    var achHostedUrl = ViewData["AchHostedUrl"] as string;
    var achVerifyHint = ViewData["AchVerifyHint"] as string; // "amounts" or "descriptor_code"
}

@Html.AntiForgeryToken()

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/css/manage-pages.css" rel="stylesheet" />
<script src="https://js.stripe.com/v3/"></script>

<style>
    .wallet-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .wallet-balance-card {
        background: var(--primary-gradient);
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
    }

    .wallet-balance-card::before {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        pointer-events: none;
    }

    .wallet-balance-icon {
        width: 56px;
        height: 56px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--border-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }

    .wallet-balance-label {
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }

    .wallet-balance-amount {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        position: relative;
        z-index: 1;
    }

    .wallet-balance-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .wallet-balance-actions .btn {
        background: white;
        color: var(--primary-color);
        border: none;
        font-weight: 600;
    }

    .wallet-balance-actions .btn:hover {
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-1px);
    }

    .wallet-balance-actions .btn-outline-light {
        background: transparent;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .wallet-balance-actions .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: white;
    }

    .default-method-card {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        transition: all var(--transition-base);
    }

    .default-method-card:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-lg);
    }

    .default-method-info h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0 0 0.25rem 0;
    }

    .default-method-info p {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin: 0;
    }

    .payment-method-item {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all var(--transition-base);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .payment-method-item:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .payment-method-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }

    .payment-method-icon {
        width: 48px;
        height: 48px;
        background: var(--gray-100);
        border-radius: var(--border-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
        color: var(--gray-600);
        flex-shrink: 0;
    }

    .payment-method-details {
        flex: 1;
    }

    .payment-method-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }

    .payment-method-meta {
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    .payment-method-actions {
        display: flex;
        gap: 0.5rem;
    }

    .ach-verify-banner {
        background: var(--warning-light);
        border: 2px solid var(--warning-color);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .ach-verify-banner-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .ach-verify-banner-title {
        font-weight: 600;
        font-size: 1rem;
        color: #92400e;
        margin: 0;
    }

    .ach-verify-content {
        color: #92400e;
    }

    .ach-verify-form {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(245, 158, 11, 0.3);
    }
</style>

<div class="manage-container">
<!-- Page Header -->
<div class="page-header">
        <div class="page-header-actions">
            <div>
                <h1>Payment Methods</h1>
                <p>Manage your wallet balance and payment methods</p>
            </div>
            <button class="btn" style="background: white; color: var(--primary-color);" data-bs-toggle="modal" data-bs-target="#addPmModal">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Add Payment Method
            </button>
        </div>
    </div>

    <!-- Wallet Summary -->
    <div class="wallet-summary-grid">
        <!-- Balance Card -->
        <div class="wallet-balance-card">
            <div class="wallet-balance-icon">
                <svg width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1H1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                    <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V5zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2H3z"/>
                </svg>
            </div>
            <div class="wallet-balance-label">Current Balance</div>
            <div class="wallet-balance-amount">@walletBalance.ToString("C")</div>
            <div class="wallet-balance-actions">
                <button class="btn" data-bs-toggle="modal" data-bs-target="#addFundsModal">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Add Credit
                </button>
            </div>
        </div>

        <!-- Default Method Card -->
        <div class="default-method-card">
            <div class="default-method-info">
                <h3>Default Payment Method</h3>
                <p>Used for subscriptions and recurring charges</p>
            </div>
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addPmModal">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                </svg>
                Change
            </button>
        </div>
    </div>

    <!-- ACH Verification Banner -->
    <div id="ach-verify-panel" class="ach-verify-banner" style="display:@(achVerifyPending ? "block" : "none")">
        <div class="ach-verify-banner-header">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: #f59e0b;">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <strong class="ach-verify-banner-title">Verify Your Bank Account</strong>
        </div>
        <div class="ach-verify-content">
            <p style="margin: 0 0 1rem 0;">
                We sent two small deposits (or a descriptor code) to your bank. Enter them here to finish setup.
            </p>
            <div id="ach-hosted-wrapper" style="display:@(string.IsNullOrWhiteSpace(achHostedUrl) ? "none" : "block"); margin-bottom: 0.75rem;">
                <a id="ach-hosted-link" class="btn btn-sm btn-primary" href="@(achHostedUrl ?? "#")" target="_blank" rel="noopener">
                    Verify on Stripe
                </a>
                <span style="margin-left: 0.5rem; font-size: 0.875rem;">or verify below:</span>
            </div>
        </div>
        <form id="ach-verify-form" class="ach-verify-form">
            <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Deposit 1 (¢)</label>
                    <input class="form-control" id="amt1" type="number" min="1" step="1" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Deposit 2 (¢)</label>
                    <input class="form-control" id="amt2" type="number" min="1" step="1" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Descriptor Code</label>
                    <input class="form-control" id="code" type="text" placeholder="SMXXXX" />
                </div>
            </div>
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                <button type="button" class="btn btn-primary btn-sm" id="verify-ach-client">Verify (Client)</button>
                <button type="button" class="btn btn-secondary btn-sm" id="verify-ach-server">Verify (Server)</button>
            </div>
            <div id="ach-hint" style="display:@(string.IsNullOrWhiteSpace(achVerifyHint) ? "none" : "block"); margin-top: 0.75rem; font-size: 0.875rem;">
                @if (!string.IsNullOrWhiteSpace(achVerifyHint))
                {
                    <text>Hint: expected verification via <strong>@achVerifyHint</strong>.</text>
                }
            </div>
        </form>
    </div>

    <!-- Payment Methods -->
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Saved Payment Methods</h2>
                <p class="card-subtitle">Manage your cards and bank accounts</p>
            </div>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPmModal">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Add Method
            </button>
        </div>
        <div class="card-body">
            @if (!Model.Methods.Any())
            {
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zM1 7v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7H1z"/>
                        </svg>
                    </div>
                    <h3 class="empty-state-title">No payment methods yet</h3>
                    <p class="empty-state-description">Add a card or bank account to speed up checkout and enable autopay</p>
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addPmModal">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        Add Your First Method
                    </button>
                </div>
            }
            else
            {
                @foreach (var pm in Model.Methods)
                {
                    var isBank = pm.WalletType == AuthScape.Models.PaymentGateway.WalletType.us_bank_account;
                    var label = isBank
                    ? (string.IsNullOrWhiteSpace(pm.BankName) ? "Bank" : pm.BankName)
                    : (string.IsNullOrWhiteSpace(pm.Brand) ? "Card" : pm.Brand);
                    var sub = isBank
                    ? (string.IsNullOrWhiteSpace(pm.AccountType) ? "US bank account" : pm.AccountType)
                    : $"Expires {pm.ExpMonth:D2}/{pm.ExpYear}";

                    var shortBrand = (label ?? (isBank ? "BANK" : "CARD")).ToUpperInvariant();
                    if (shortBrand.Length > 4) { shortBrand = shortBrand.Substring(0, 4); }

                    <div class="payment-method-item">
                        <div class="payment-method-info">
                            <div class="payment-method-icon">@shortBrand</div>
                            <div class="payment-method-details">
                                <div class="payment-method-name">@label •••• @pm.Last4</div>
                                <div class="payment-method-meta">@sub</div>
                            </div>
                        </div>
                        <div class="payment-method-actions">
                            <button class="btn btn-sm btn-outline make-default" data-pmid="@pm.PaymentMethodId">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                </svg>
                                Make Default
                            </button>
                            <button class="btn btn-sm btn-danger delete-method" data-pmid="@pm.PaymentMethodId">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                                </svg>
                                Remove
                            </button>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div> <!-- /.manage-container -->

<!-- Add Funds Modal -->
<div class="modal fade" id="addFundsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Credit</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="add-funds-form" class="modal-body">
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <div style="position: relative;">
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-500); font-weight: 600;">$</span>
                        <input id="topup" type="number" min="1" step="1" class="form-control" placeholder="25" style="padding-left: 2rem;">
                    </div>
                    <span class="form-help">Funds will be added to your wallet balance</span>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="add-funds-form" class="btn btn-primary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    Proceed to Pay
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Method Modal -->
<div class="modal fade" id="addPmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Payment Method</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="pm-form">
                <div class="modal-body">
                    <div id="payment-element" style="padding: 1.5rem; border: 2px solid var(--gray-200); border-radius: var(--border-radius-md);"></div>
                    <span class="form-help" style="display: block; margin-top: 1rem;">Your information is stored securely with Stripe</span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="savePm" class="btn btn-primary">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        Save Payment Method
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const anti = document.querySelector('input[name="__RequestVerificationToken"]').value;
    const stripe = Stripe("@Model.StripePublicKey");
    const activeWalletId = "@Model.ActiveWalletId";

    // --- helper to POST to Razor Page handlers
    async function postToHandler(handler, bodyObjOrFormData) {
      const url = `/Wallets?handler=${encodeURIComponent(handler)}`;
      const options = { method: 'POST' };
      if (bodyObjOrFormData instanceof FormData) {
        bodyObjOrFormData.append('__RequestVerificationToken', anti);
        options.body = bodyObjOrFormData;
      } else {
        const form = new URLSearchParams();
        for (const [k, v] of Object.entries(bodyObjOrFormData || {})) form.append(k, v);
        form.append('__RequestVerificationToken', anti);
        options.body = form;
      }
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(await res.text());
      const ct = res.headers.get('content-type') || "";
      return ct.includes('application/json') ? res.json() : res.text();
    }

    // ---------- Add Funds (Checkout)
    document.getElementById('add-funds-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const dollars = Number(document.getElementById('topup').value || 0);
      if (!dollars || dollars < 1) { alert("Enter an amount ≥ $1"); return; }
      const data = { amountCents: Math.round(dollars * 100), walletId: activeWalletId };
      const { url } = await postToHandler('AddFunds', data);
      window.location = url;
    });

    // ---------- Stripe Elements lifecycle (prevents "Element destroyed" errors)
    const addPmModal = document.getElementById('addPmModal');
    const paymentElementContainer = document.getElementById('payment-element');

    let elements = null;
    let paymentElement = null;
    let clientSecretCurrent = null;
    let isMounting = false;
    let isSubmitting = false;

    addPmModal.addEventListener('shown.bs.modal', async () => {
      if (isMounting || paymentElement) return;
      try {
        isMounting = true;
        const { clientSecret } = await postToHandler('SetupIntent', { walletId: activeWalletId });
        clientSecretCurrent = clientSecret;

        paymentElementContainer.innerHTML = '';
        elements = stripe.elements({ clientSecret });
        paymentElement = elements.create('payment', { paymentMethodOrder: ['us_bank_account', 'card'] });
        paymentElement.mount('#payment-element');
      } catch (err) {
        console.error('SetupIntent error:', err);
        const errorMsg = err.message || (typeof err === 'string' ? err : JSON.stringify(err));
        alert('Unable to initialize payment form: ' + errorMsg);
      } finally {
        isMounting = false;
      }
    });

    addPmModal.addEventListener('hidden.bs.modal', () => {
      try { if (paymentElement) paymentElement.destroy(); }
      finally {
        paymentElement = null;
        elements = null;
        clientSecretCurrent = null;
        paymentElementContainer.innerHTML = '';
        isSubmitting = false;
        isMounting = false;
      }
    });

    document.getElementById('pm-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isSubmitting) return;
      if (!elements || !paymentElement || !clientSecretCurrent) {
        alert('Payment form is not ready. Please reopen "Add Payment Method".');
        return;
      }
      isSubmitting = true;
      const saveBtn = document.getElementById('savePm');
      saveBtn.disabled = true;

      try {
        const { error } = await stripe.confirmSetup({
          elements,
          confirmParams: { return_url: window.location.href } // back with ?setup_intent=... & ?setup_intent_client_secret=...
        });
        if (error) alert(error.message);
      } catch (err) {
        alert(err?.message || 'Could not save payment method.');
      } finally {
        isSubmitting = false;
        saveBtn.disabled = false;
      }
    });

    // ---------- Make default / Delete
    document.querySelectorAll('.make-default').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const pmId = e.currentTarget.dataset.pmid;
        await postToHandler('MakeDefault', { pmId, walletId: activeWalletId });
        location.reload();
      });
    });

    document.querySelectorAll('.delete-method').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const pmId = e.currentTarget.dataset.pmid;
        if (!confirm('Remove this payment method?')) return;
        await postToHandler('DeleteMethod', { pmId, walletId: activeWalletId });
        location.reload();
      });
    });

    // ---------- ACH micro‑deposits verification

    // On load, if server didn't show banner, ask backend if verification is pending.
    document.addEventListener('DOMContentLoaded', async () => {
      const banner = document.getElementById('ach-verify-panel');
      const alreadyVisible = banner && banner.style.display !== 'none';
      if (alreadyVisible) return;

      const params = new URLSearchParams(window.location.search);
      const siClientSecret = params.get('setup_intent_client_secret');

      try {
        const payload = {};
        if (siClientSecret) payload.clientSecret = siClientSecret;
        const res = await postToHandler('AchStatus', payload);

        if (res && res.needsVerification) {
          banner.style.display = 'block';

          if (res.hostedVerificationUrl) {
            const wrap = document.getElementById('ach-hosted-wrapper');
            const link = document.getElementById('ach-hosted-link');
            wrap.style.display = 'block';
            link.href = res.hostedVerificationUrl;
          }

          if (res.microdepositType) {
            const hint = document.getElementById('ach-hint');
            hint.style.display = 'block';
            hint.innerHTML = `Hint: expected verification via <b>${res.microdepositType}</b>.`;
          }

          if (res.clientSecret && !siClientSecret) {
            window.__achClientSecret = res.clientSecret; // cache for client-side verify
          }
        }
      } catch (e) {
        console.warn('ACH status probe failed:', e);
      }
    });

    function getSiClientSecretFromUrlOrCache() {
      const params = new URLSearchParams(window.location.search);
      return params.get('setup_intent_client_secret') || window.__achClientSecret || null;
    }

    const verifyClientBtn = document.getElementById('verify-ach-client');
    const verifyServerBtn = document.getElementById('verify-ach-server');

    async function doClientVerify() {
      const siClientSecret = getSiClientSecretFromUrlOrCache();
      if (!siClientSecret) {
        alert("Missing verification token. Use 'Verify on Stripe' above or the Server Verify button.");
        return;
      }
      const a1 = document.getElementById('amt1').value;
      const a2 = document.getElementById('amt2').value;
      const code = (document.getElementById('code').value || '').trim();

      let result;
      if (code) {
        result = await stripe.verifyMicrodepositsForSetup({ clientSecret: siClientSecret, descriptorCode: code });
      } else if (a1 && a2) {
        result = await stripe.verifyMicrodepositsForSetup({ clientSecret: siClientSecret, amounts: [Number(a1), Number(a2)] });
      } else {
        alert('Enter both deposit amounts or the descriptor code.');
        return;
      }

      if (result.error) { alert(result.error.message); return; }
      location.href = window.location.pathname; // reload so backend saves PM in succeeded branch
    }

    async function doServerVerify() {
      const payload = {
        clientSecret: getSiClientSecretFromUrlOrCache(),
        amount1: Number(document.getElementById('amt1').value || 0),
        amount2: Number(document.getElementById('amt2').value || 0),
        descriptorCode: (document.getElementById('code').value || '').trim()
      };
      const res = await postToHandler('VerifyAch', payload);
      if (res.status === 'succeeded') location.reload();
      else alert('Verification status: ' + res.status);
    }

    verifyClientBtn?.addEventListener('click', doClientVerify);
    verifyServerBtn?.addEventListener('click', doServerVerify);
</script>
